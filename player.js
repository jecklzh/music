document.addEventListener("DOMContentLoaded",()=>{const t={skipHistory:{},currentPreferredTags:[],init(){this.skipHistory=JSON.parse(localStorage.getItem("skipHistory")||"{}")},save(){localStorage.setItem("skipHistory",JSON.stringify(this.skipHistory))},getCombos(t){const e=[],s=(t,i=[],a=0)=>{i.length>=2&&e.push([...i].sort().join("|"));for(let e=a;e<t.length;e++)i.push(t[e]),s(t,i,e+1),i.pop()};return s(t),e},recordSkip(t){t.forEach(t=>{this.skipHistory[t]=Math.min((this.skipHistory[t]||0)+.5,10)}),this.getCombos(t).forEach(t=>{const e=this.skipHistory[t]||0;this.skipHistory[t]=Math.min(e+(.3*e+1),15)}),this.save()},recordCompleted(t){this.currentPreferredTags=t,t.forEach(t=>{this.skipHistory[t]&&(this.skipHistory[t]*=.5)}),this.getCombos(t).forEach(t=>{this.skipHistory[t]&&(this.skipHistory[t]*=.3)}),this.save()},computeWeight(t){const e=t.tags,s=this.getCombos(e);let i=0,a=0;e.forEach(t=>{i+=.1*(this.skipHistory[t]||0),a++}),s.forEach(t=>{i+=.3*(this.skipHistory[t]||0),a++});const o=a>0?i/a:0,n=Math.max(1-o,.1);let d=0;Array.isArray(this.currentPreferredTags)&&(d=e.filter(t=>this.currentPreferredTags.includes(t)).length/e.length);const r=.22*n+.78*d;return Math.max(r,.1)},pick(t){const e=t.map((t,e)=>({idx:e,weight:this.computeWeight(t)})),s=e.reduce((t,e)=>t+e.weight,0),i=Math.random()*s;let a=0;for(const t of e)if(a+=t.weight,i<a)return t.idx;return 0}},e={state:{currentIndex:0,musicList:[],historyStack:[],fadeInterval:null,isPausing:!1,preloadIndex:null},dom:{audio:document.getElementById("audio"),audioPreload:document.getElementById("audio-preload"),title:document.getElementById("song-title"),tags:document.getElementById("song-tags"),relatedContainer:document.getElementById("related-songs"),searchResults:document.getElementById("search-results"),searchInput:document.getElementById("tag-search"),prevBtn:document.getElementById("prev-btn"),nextBtn:document.getElementById("next-btn"),playPauseBtn:document.getElementById("play-pause-btn"),progressContainer:document.getElementById("progress-container"),progressBar:document.getElementById("progress-bar"),currentTime:document.getElementById("current-time"),duration:document.getElementById("duration"),volumeIcon:document.getElementById("volume-icon"),volumeSliderContainer:document.getElementById("volume-slider-container"),volumeSlider:document.getElementById("volume-slider")},async init(){this.handleWelcomeModal(),t.init(),await this.loadMusicList(),this.bindEvents(),this.initializeVolume();const e=localStorage.getItem("lastSongIndex"),s=parseFloat(localStorage.getItem("lastSongTime")||0);null!==e&&this.state.musicList[e]?this.updatePlayer(parseInt(e,10),s,!0):this.state.musicList.length>0?this.updatePlayer(t.pick(this.state.musicList),0,!0):this.dom.title.textContent="音乐列表为空"},handleWelcomeModal(){const t=document.getElementById("welcome-overlay"),e=document.getElementById("welcome-agree-btn"),s="welcomeInfo",i=()=>t.classList.remove("hidden"),a=()=>t.classList.add("hidden");e.addEventListener("click",()=>{const t=24*(Math.floor(5*Math.random())+5)*60*60*1e3,e={timestamp:Date.now(),interval:t};localStorage.setItem(s,JSON.stringify(e)),a()});try{const t=JSON.parse(localStorage.getItem(s));t&&t.timestamp&&t.interval?Date.now()-t.timestamp>t.interval?i():a():i()}catch(t){i()}},initializeVolume(){const t=localStorage.getItem("playerVolume"),e=null!==t?parseFloat(t):1;this.dom.audio.volume=e,this.dom.volumeSlider.value=e,this.updateVolumeIcon(e)},async loadMusicList(){try{const t=await fetch("list.json");if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);this.state.musicList=await t.json()}catch(t){this.dom.title.textContent="加载列表失败"}},formatTime:t=>`${Math.floor(t/60)}:${Math.floor(t%60).toString().padStart(2,"0")}`,bindEvents(){this.dom.playPauseBtn.addEventListener("click",()=>this.togglePlayPause()),this.dom.nextBtn.addEventListener("click",()=>{const e=this.state.musicList[this.state.currentIndex],s=this.dom.audio;!isNaN(s.duration)&&s.currentTime<.5*s.duration&&t.recordSkip(e.tags),this.fadeOut(()=>this.playNext())}),this.dom.prevBtn.addEventListener("click",()=>this.fadeOut(()=>this.playPrevious())),this.dom.audio.addEventListener("play",()=>{this.dom.playPauseBtn.innerHTML='<i class="fas fa-pause"></i>',this.state.isPausing=!1,this.dom.audio.currentTime<2&&this.preloadNextSong()}),this.dom.audio.addEventListener("pause",()=>{this.dom.playPauseBtn.innerHTML='<i class="fas fa-play"></i>'}),this.dom.audio.addEventListener("ended",()=>{t.recordCompleted(this.state.musicList[this.state.currentIndex].tags),this.playNext(!0)}),this.dom.audio.addEventListener("timeupdate",()=>this.updateProgress()),this.dom.audio.addEventListener("loadedmetadata",()=>this.updateProgress()),this.dom.progressContainer.addEventListener("click",t=>this.seek(t)),this.dom.searchInput.addEventListener("input",()=>this.handleSearch()),this.dom.audio.addEventListener("contextmenu",t=>t.preventDefault()),this.dom.audio.onerror=()=>{this.dom.title.textContent="音频加载失败, 5秒后尝试下一首...",setTimeout(()=>this.playNext(!0),5e3)},this.dom.volumeIcon.addEventListener("click",t=>{t.stopPropagation(),this.dom.volumeSliderContainer.classList.toggle("show")}),this.dom.volumeSlider.addEventListener("input",t=>{this.setVolume(t.target.value)}),document.addEventListener("click",t=>{this.dom.volumeSliderContainer.contains(t.target)||this.dom.volumeIcon.contains(t.target)||this.dom.volumeSliderContainer.classList.remove("show")}),window.addEventListener("beforeunload",()=>this.savePlaybackPosition())},preloadNextSong(){let e,i=0;do{const a=t.pick(this.state.musicList);if(a!==this.state.currentIndex&&s.isSongAllowed(this.state.musicList[a])){e=a;break}i++}while(i<20);if(null!=e){const t=this.state.musicList[e];this.dom.audioPreload.src=`https://music.stevel.eu.org/${encodeURIComponent(t.file)}`,this.dom.audioPreload.load(),this.state.preloadIndex=e}else this.state.preloadIndex=null},setVolume(t){this.dom.audio.volume=t,this.updateVolumeIcon(t),localStorage.setItem("playerVolume",t)},updateVolumeIcon(t){this.dom.volumeIcon.querySelector("i").className=0==t?"fas fa-volume-mute":t<.5?"fas fa-volume-down":"fas fa-volume-up"},updateProgress(){const{duration:t,currentTime:e}=this.dom.audio;t&&(this.dom.progressBar.style.width=e/t*100+"%",this.dom.duration.textContent=this.formatTime(t),this.dom.currentTime.textContent=this.formatTime(e))},seek(t){const{clientWidth:e}=this.dom.progressContainer,{offsetX:s}=t,{duration:i}=this.dom.audio;i&&(this.dom.audio.currentTime=s/e*i)},togglePlayPause(){this.dom.audio.paused?(this.state.isPausing=!1,this.fadeIn()):(this.state.isPausing=!0,this.fadeOut(()=>{this.dom.audio.pause()}))},updatePlayer(e,s=0,i=!1){if(!this.state.musicList[e])return;this.state.currentIndex=e;const a=this.state.musicList[e];this.dom.title.textContent=a.title,this.dom.tags.textContent=a.tags.join(", "),this.state.preloadIndex===e&&this.dom.audioPreload.src?this.dom.audio.src=this.dom.audioPreload.src:this.dom.audio.src=`https://music.stevel.eu.org/${encodeURIComponent(a.file)}`,this.dom.audio.onloadedmetadata=()=>{this.dom.audio.currentTime=s,this.updateProgress(),i||this.fadeIn()},this.renderRelatedSongs(a),"mediaSession"in navigator&&(navigator.mediaSession.metadata=new MediaMetadata({title:a.title}),navigator.mediaSession.setActionHandler("play",()=>this.togglePlayPause()),navigator.mediaSession.setActionHandler("pause",()=>this.togglePlayPause()),navigator.mediaSession.setActionHandler("previoustrack",()=>this.fadeOut(()=>this.playPrevious())),navigator.mediaSession.setActionHandler("nexttrack",()=>{t.recordSkip(a.tags),this.fadeOut(()=>this.playNext())}))},playSongByIndex(t){this.state.historyStack.push(this.state.currentIndex),this.fadeOut(()=>this.updatePlayer(t))},playNext(e=!1){let i=this.state.preloadIndex;if(null===i){let e=0,a=20;do{const a=t.pick(this.state.musicList);if(s.isSongAllowed(this.state.musicList[a])){i=a;break}e++}while(e<a)}null!==i?(this.state.historyStack.push(this.state.currentIndex),this.updatePlayer(i)):this.fadeOut(()=>this.dom.audio.pause())},stopPlaybackDueToTimer(){this.state.isPausing=!0,this.fadeOut(()=>this.dom.audio.pause())},playPrevious(){if(this.state.historyStack.length>0){const t=this.state.historyStack.pop();this.updatePlayer(t)}},renderRelatedSongs(e){this.dom.relatedContainer.innerHTML="",this.state.musicList.filter(t=>t.file!==e.file&&t.tags.some(t=>e.tags.includes(t))).map(e=>({song:e,weight:t.computeWeight(e)})).sort((t,e)=>e.weight-t.weight).slice(0,5).forEach(({song:t})=>{const e=document.createElement("div");e.className="related-song",e.innerHTML=`${t.title} <span class="song-tags">(${t.tags.join(", ")})</span>`,e.addEventListener("click",()=>{const e=this.state.musicList.findIndex(e=>e.file===t.file);-1!==e&&this.playSongByIndex(e)}),this.dom.relatedContainer.appendChild(e)})},handleSearch(){const t=this.dom.searchInput.value.trim().toLowerCase();this.dom.searchResults.innerHTML="",t&&this.state.musicList.filter(e=>e.title.toLowerCase().includes(t)||e.tags.some(e=>e.toLowerCase().includes(t))).slice(0,5).forEach(t=>{const e=document.createElement("div");e.className="search-result-item",e.innerHTML=`${t.title} <span class="song-tags">${t.tags.join(", ")}</span>`,e.addEventListener("click",()=>{const e=this.state.musicList.findIndex(e=>e.file===t.file);-1!==e&&this.playSongByIndex(e),this.dom.searchInput.value="",this.dom.searchResults.innerHTML=""}),this.dom.searchResults.appendChild(e)})},savePlaybackPosition(){this.dom.audio.currentTime>0&&(localStorage.setItem("lastSongIndex",this.state.currentIndex),localStorage.setItem("lastSongTime",this.dom.audio.currentTime))},fadeOut(t){clearInterval(this.state.fadeInterval);const e=this.dom.audio,s=e.volume;if(0===s)return void(t&&t());const i=s/20;this.state.fadeInterval=setInterval(()=>{const s=e.volume-i;s<=0?(e.volume=0,clearInterval(this.state.fadeInterval),t&&t()):e.volume=s},15)},fadeIn(){clearInterval(this.state.fadeInterval);const t=this.dom.audio,e=parseFloat(localStorage.getItem("playerVolume")||"0.75");t.paused&&(t.volume=0,t.play().catch(t=>{}));const s=t.volume;if(s>=e)return;const i=(e-s)/20;this.state.fadeInterval=setInterval(()=>{const s=t.volume+i;s>=e?(t.volume=e,clearInterval(this.state.fadeInterval)):t.volume=s},15)}},s={endTime:null,tagFilter:[],intervalId:null,isActive(){return null!==this.endTime},start(t,e){this.stop(),this.endTime=Date.now()+60*t*1e3,this.tagFilter=[e],this.intervalId=setInterval(()=>this.updateRemainingTime(),1e3),document.getElementById("sleep-status").textContent=`已启用：播放 ${t} 分钟，「${e}」`,this.updateRemainingTime()},stop(){clearInterval(this.intervalId),this.intervalId=null,this.endTime=null,this.tagFilter=[],document.getElementById("sleep-status").textContent="未启用"},isSongAllowed(t){return!this.isActive()||0===this.tagFilter.length||t.tags.some(t=>this.tagFilter.includes(t))},updateRemainingTime(){if(!this.isActive())return;const t=this.endTime-Date.now();if(t<=0)return e.stopPlaybackDueToTimer(),void this.stop();const s=Math.floor(t/6e4),i=Math.floor(t%6e4/1e3).toString().padStart(2,"0");document.getElementById("sleep-status").textContent=`剩余: ${s}:${i}，仅播放「${this.tagFilter[0]}」`}};document.getElementById("sleep-toggle").addEventListener("click",()=>{const t=document.getElementById("sleep-panel");t.style.display="none"===t.style.display?"block":"none"}),document.querySelectorAll(".tag-btn").forEach(t=>{t.addEventListener("click",()=>{document.querySelectorAll(".tag-btn").forEach(t=>t.classList.remove("selected")),t.classList.add("selected")})}),document.getElementById("sleep-minutes").addEventListener("change",()=>{const t=document.querySelector(".tag-btn.selected"),e=parseInt(document.getElementById("sleep-minutes").value);t&&e&&s.start(e,t.dataset.tag)}),document.getElementById("sleep-stop-btn").addEventListener("click",()=>{s.stop()}),e.init()});
