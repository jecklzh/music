document.addEventListener('DOMContentLoaded',()=>{const Recommender={skipHistory:{},currentPreferredTags:[],init(){this.skipHistory=JSON.parse(localStorage.getItem('skipHistory')||'{}')},save(){localStorage.setItem('skipHistory',JSON.stringify(this.skipHistory))},getCombos(t){const o=[];const e=(t,n=[],s=0)=>{if(n.length>=2){o.push([...n].sort().join("|"))}for(let i=s;i<t.length;i++){n.push(t[i]);e(t,n,i+1);n.pop()}};e(t);return o},recordSkip(t){t.forEach(t=>{this.skipHistory[t]=Math.min((this.skipHistory[t]||0)+.5,10)});this.getCombos(t).forEach(t=>{const o=this.skipHistory[t]||0;this.skipHistory[t]=Math.min(o+(o*.3+1),15)});this.save()},recordCompleted(t){this.currentPreferredTags=t;t.forEach(t=>{if(this.skipHistory[t]){this.skipHistory[t]*=.5}});this.getCombos(t).forEach(t=>{if(this.skipHistory[t]){this.skipHistory[t]*=.3}});this.save()},computeWeight(t){const o=t.tags;const e=this.getCombos(o);let n=0,s=0;o.forEach(t=>{n+=(this.skipHistory[t]||0)*.1;s++});e.forEach(t=>{n+=(this.skipHistory[t]||0)*.3;s++});const i=s>0?n/s:0;const a=Math.max(1-i,.1);let r=0;if(Array.isArray(this.currentPreferredTags)){const t=o.filter(t=>this.currentPreferredTags.includes(t)).length;r=t/o.length}const l=a*.22+r*.78;return Math.max(l,.1)},pick(t){const o=t.map((t,o)=>({idx:o,weight:this.computeWeight(t)}));const e=o.reduce((t,o)=>t+o.weight,0);const n=Math.random()*e;let s=0;for(const i of o){s+=i.weight;if(n<s)return i.idx}return 0}};const MusicPlayer={state:{currentIndex:0,musicList:[],historyStack:[],fadeInterval:null,isPausing:false},dom:{audio:document.getElementById('audio'),originalVolume:1,title:document.getElementById('song-title'),tags:document.getElementById('song-tags'),relatedContainer:document.getElementById('related-songs'),searchResults:document.getElementById('search-results'),searchInput:document.getElementById('tag-search'),prevBtn:document.getElementById('prev-btn'),nextBtn:document.getElementById('next-btn'),playPauseBtn:document.createElement('button'),progressContainer:document.getElementById('progress-container'),progressBar:document.getElementById('progress-bar'),currentTime:document.getElementById('current-time'),duration:document.getElementById('duration')},async init(){console.log('Player initializing...');this.createCustomControls();Recommender.init();await this.loadMusicList();this.bindEvents();const t=localStorage.getItem('lastSongIndex'),o=parseFloat(localStorage.getItem('lastSongTime')||0);if(t!==null&&this.state.musicList[t]){this.updatePlayer(parseInt(t),o,true)}else if(this.state.musicList.length>0){this.updatePlayer(Recommender.pick(this.state.musicList),0,true)}else{this.dom.title.textContent="音乐列表为空"}},createCustomControls(){this.dom.playPauseBtn.id='play-pause-btn';this.dom.playPauseBtn.innerHTML='<i class="fas fa-play"></i>';const t=this.dom.nextBtn.parentElement;t.insertBefore(this.dom.playPauseBtn,this.dom.nextBtn)},async loadMusicList(){try{const t=await fetch('list.json');if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);this.state.musicList=await t.json();console.log('Music list loaded:',this.state.musicList)}catch(t){console.error('加载音乐列表失败:',t);this.dom.title.textContent="加载列表失败"}},formatTime(t){const o=Math.floor(t/60);const e=Math.floor(t%60).toString().padStart(2,'0');return`${o}:${e}`},bindEvents(){this.dom.playPauseBtn.addEventListener('click',()=>this.togglePlayPause());this.dom.nextBtn.addEventListener('click',()=>{const t=this.state.musicList[this.state.currentIndex];const o=this.dom.audio;if(!isNaN(o.duration)&&o.currentTime<o.duration*.5){Recommender.recordSkip(t.tags)}this.fadeOut(()=>this.playNext())});this.dom.prevBtn.addEventListener('click',()=>this.fadeOut(()=>this.playPrevious()));this.dom.audio.addEventListener('play',()=>{this.dom.playPauseBtn.innerHTML='<i class="fas fa-pause"></i>';this.state.isPausing=false});this.dom.audio.addEventListener('pause',()=>{this.dom.playPauseBtn.innerHTML='<i class="fas fa-play"></i>'});this.dom.audio.addEventListener('ended',()=>{Recommender.recordCompleted(this.state.musicList[this.state.currentIndex].tags);this.playNext(true)});this.dom.audio.addEventListener('timeupdate',()=>this.updateProgress());this.dom.audio.addEventListener('loadedmetadata',()=>this.updateProgress());this.dom.progressContainer.addEventListener('click',t=>this.seek(t));this.dom.searchInput.addEventListener('input',()=>this.handleSearch());this.dom.audio.addEventListener('contextmenu',t=>t.preventDefault());this.dom.audio.onerror=()=>{console.error("音频播放错误:",this.dom.audio.error);this.dom.title.textContent="音频加载失败, 5秒后尝试下一首...";setTimeout(()=>this.playNext(true),5e3)};const t=document.getElementById('sleep-toggle');if(t){const o=()=>{t.style.color='#333'};const e=()=>{t.style.color='#888'};t.addEventListener('touchstart',o);t.addEventListener('touchend',e);t.addEventListener('mouseenter',o);t.addEventListener('mouseleave',e)}},updateProgress(){const{duration:t,currentTime:o}=this.dom.audio;if(t){this.dom.progressBar.style.width=`${o/t*100}%`;this.dom.duration.textContent=this.formatTime(t);this.dom.currentTime.textContent=this.formatTime(o)}},seek(t){const{clientWidth:o}=this.dom.progressContainer,{offsetX:e}=t,{duration:n}=this.dom.audio;if(n){this.dom.audio.currentTime=e/o*n}},togglePlayPause(){if(this.dom.audio.paused){this.state.isPausing=false;this.fadeIn()}else{this.state.isPausing=true;this.fadeOut()}},updatePlayer(t,o=0,e=false){if(!this.state.musicList[t])return;this.state.currentIndex=t;const n=this.state.musicList[t];this.dom.title.textContent=n.title;this.dom.tags.textContent=n.tags.join(', ');this.dom.audio.src=`https://music.stevel.eu.org/${encodeURIComponent(n.file)}`;this.dom.audio.onloadedmetadata=()=>{this.dom.audio.currentTime=o;this.updateProgress();if(!e){this.fadeIn()}};this.renderRelatedSongs(n);if('mediaSession'in navigator){navigator.mediaSession.metadata=new MediaMetadata({title:n.title});navigator.mediaSession.setActionHandler('play',()=>this.togglePlayPause());navigator.mediaSession.setActionHandler('pause',()=>this.togglePlayPause());navigator.mediaSession.setActionHandler('previoustrack',()=>this.fadeOut(()=>this.playPrevious()));navigator.mediaSession.setActionHandler('nexttrack',()=>{Recommender.recordSkip(n.tags);this.fadeOut(()=>this.playNext())})}},playSongByIndex(t){this.state.historyStack.push(this.state.currentIndex);this.fadeOut(()=>this.updatePlayer(t))},playNext(t=false){let o=null,e=0,n=20;do{const s=Recommender.pick(this.state.musicList);if(SleepController.isSongAllowed(this.state.musicList[s])){o=s;break}e++}while(e<n);if(o!==null){this.state.historyStack.push(this.state.currentIndex);if(t){this.updatePlayer(o)}else{this.fadeOut(()=>this.updatePlayer(o))}}else{console.log('在睡眠模式下，未找到符合条件的歌曲，暂停播放。');this.fadeOut(()=>this.dom.audio.pause())}},stopPlaybackDueToTimer(){console.log("Timer expired. Fading out and pausing audio.");this.state.isPausing=true;this.fadeOut(()=>this.dom.audio.pause())},playPrevious(){if(this.state.historyStack.length>0){const t=this.state.historyStack.pop();this.updatePlayer(t)}},renderRelatedSongs(t){this.dom.relatedContainer.innerHTML='';const o=this.state.musicList.filter(o=>o.file!==t.file&&o.tags.some(o=>t.tags.includes(o))).map(t=>({song:t,weight:Recommender.computeWeight(t)})).sort((t,o)=>o.weight-t.weight).slice(0,5);o.forEach(({song:t})=>{const o=document.createElement('div');o.className='related-song';o.innerHTML=`${t.title} <span class="song-tags">(${t.tags.join(', ')})</span>`;o.addEventListener('click',()=>{const o=this.state.musicList.findIndex(o=>o.file===t.file);if(o!==-1)this.playSongByIndex(o)});this.dom.relatedContainer.appendChild(o)})},handleSearch(){const t=this.dom.searchInput.value.trim().toLowerCase();this.dom.searchResults.innerHTML='';if(!t)return;const o=this.state.musicList.filter(o=>o.title.toLowerCase().includes(t)||o.tags.some(t=>t.toLowerCase().includes(t))).slice(0,5);o.forEach(t=>{const o=document.createElement('div');o.className='search-result-item';o.innerHTML=`${t.title} <span class="song-tags">${t.tags.join(', ')}</span>`;o.addEventListener('click',()=>{const o=this.state.musicList.findIndex(o=>o.file===t.file);if(o!==-1)this.playSongByIndex(o);this.dom.searchInput.value='';this.dom.searchResults.innerHTML=''});this.dom.searchResults.appendChild(o)})},savePlaybackPosition(){if(!isNaN(this.dom.audio.currentTime)&&this.dom.audio.currentTime>0){localStorage.setItem('lastSongIndex',this.state.currentIndex);localStorage.setItem('lastSongTime',this.dom.audio.currentTime)}},fadeOut(t){clearInterval(this.state.fadeInterval);const o=.05,e=25,n=this.dom.audio;if(n.volume===0){if(this.state.isPausing)n.pause();if(t)t();return}this.state.fadeInterval=setInterval(()=>{if(n.volume>o){n.volume=Math.max(0,n.volume-o)}else{n.volume=0;clearInterval(this.state.fadeInterval);if(this.state.isPausing){n.pause()}if(t)t()}},e)},fadeIn(){clearInterval(this.state.fadeInterval);const t=.05,o=25,e=this.dom.audio;if(e.paused){e.play().catch(t=>console.warn('自动播放可能被浏览器阻止:',t))}if(e.volume===this.dom.originalVolume){return}this.state.fadeInterval=setInterval(()=>{if(e.volume<this.dom.originalVolume-t){e.volume=Math.min(this.dom.originalVolume,e.volume+t)}else{e.volume=this.dom.originalVolume;clearInterval(this.state.fadeInterval)}},o)}};const SleepController={endTime:null,tagFilter:[],intervalId:null,isActive(){return this.endTime!==null},start(t,o){this.stop();this.endTime=Date.now()+t*60*1e3;this.tagFilter=[o];this.intervalId=setInterval(()=>this.updateRemainingTime(),1e3);document.getElementById('sleep-status').textContent=`已启用：播放 ${t} 分钟，「${o}」`;this.updateRemainingTime()},stop(){clearInterval(this.intervalId);this.intervalId=null;this.endTime=null;this.tagFilter=[];document.getElementById('sleep-status').textContent='未启用'},isSongAllowed(t){if(!this.isActive()||this.tagFilter.length===0)return true;return t.tags.some(t=>this.tagFilter.includes(t))},updateRemainingTime(){if(!this.isActive())return;const t=this.endTime-Date.now();if(t<=0){console.log("Timer has expired. Issuing stop command.");MusicPlayer.stopPlaybackDueToTimer();this.stop();return}const o=Math.floor(t/6e4);const e=Math.floor(t%6e4/1e3).toString().padStart(2,'0');document.getElementById('sleep-status').textContent=`剩余: ${o}:${e}，仅播放「${this.tagFilter[0]}」`}};document.getElementById('sleep-toggle').addEventListener('click',()=>{const t=document.getElementById('sleep-panel');t.style.display=t.style.display==='none'?'block':'none'});document.querySelectorAll('.tag-btn').forEach(t=>{t.addEventListener('click',()=>{document.querySelectorAll('.tag-btn').forEach(t=>t.classList.remove('selected'));t.classList.add('selected')})});document.getElementById('sleep-minutes').addEventListener('change',()=>{const t=document.querySelector('.tag-btn.selected');const o=parseInt(document.getElementById('sleep-minutes').value);if(t&&o){SleepController.start(o,t.dataset.tag)}});document.getElementById('sleep-stop-btn').addEventListener('click',()=>SleepController.stop());MusicPlayer.init()});
